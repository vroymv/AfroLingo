// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id    String @id @default(uuid())
  email String @unique
  name  String

  // Profile image
  profileImageUrl String? // URL to user's profile image
  // Onboarding selections
  selectedLanguage      String? // e.g., "sw", "zu", "ln", "xh"
  selectedLevel         String? // e.g., "absolute-beginner", "beginner", "refresher"
  placementTestScore    Int?
  learningReasons       String[]  @default([]) // Array of reasons why they're learning
  timeCommitment        String? // e.g., "5min", "15min", "30min"
  onboardingCompleted   Boolean   @default(false)
  onboardingCompletedAt DateTime?
  currentOnboardingStep String? // Tracks the last onboarding step completed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  progress         UserProgress[]
  activityProgress ActivityProgress[]
  dailyActivity    UserDailyActivity[]
  mistakes         UserMistake[]

  @@map("users")
}

// Unit model - Represents a learning unit (e.g., "The Alphabet", "Numbers")
model Unit {
  id           String   @id @default(uuid())
  externalId   String   @unique // e.g., "unit-1" from JSON
  title        String
  level        String // e.g., "Absolute Beginner", "Beginner"
  icon         String // Emoji icon
  color        String // Hex color code
  xpReward     Int
  order        Int      @default(0) // For ordering units
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  userProgress UserProgress[]
  activities   Activity[]
  mistakes     UserMistake[]

  @@index([externalId])
  @@index([order])
  @@map("units")
}


// Activity model - Represents an activity within a lesson
model Activity {
  id          String  @id @default(uuid())
  externalId  String  @unique // e.g., "activity-alphabet-1" from JSON
  unitId      String
  type        String // e.g., "introduction", "alphabet", "multiple-choice", etc.
  question    String  @db.Text
  description String? @db.Text
  audio       String? // Path to audio file
  order       Int     @default(0) // For ordering activities within a lesson
  isActive    Boolean @default(true)

  // Activity-specific fields (stored as JSON for flexibility)
  options       Json? // For multiple-choice: array of options
  correctAnswer Json? // For multiple-choice: index or value
  explanation   String? @db.Text
  items         Json? // For vocabulary tables, spelling completion, etc.
  pairs         Json? // For matching activities
  conversation  Json? // For conversation practice
  dialogue      Json? // For dialogue activities
  alphabetImage String? // For alphabet activities

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  unit             Unit               @relation(fields: [unitId], references: [id], onDelete: Cascade)
  activityProgress ActivityProgress[]
  mistakes         UserMistake[]

  @@index([externalId])
  @@index([unitId])
  @@index([order])
  @@index([type])
  @@map("activities")
}

// User progress for units
model UserProgress {
  id               String    @id @default(uuid())
  userId           String
  unitId           String
  progress         Int       @default(0) // 0-100
  completedActivities Int    @default(0)
  xpEarned         Int       @default(0)
  startedAt        DateTime  @default(now())
  completedAt      DateTime?
  lastAccessedAt   DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([userId, unitId])
  @@index([userId])
  @@index([unitId])
  @@map("user_progress")
}

// Removed LessonProgress model

// User progress for individual activities
model ActivityProgress {
  id               String  @id @default(uuid())
  userId           String
  activityId       String
  // Removed lessonProgressId

  // Completion status
  isCompleted Boolean  @default(false)
  isCorrect   Boolean? // For activities with right/wrong answers
  isSkipped   Boolean  @default(false) // Did user skip this activity

  // Answer tracking
  userAnswer    Json? // Store user's final answer(s)
  answerHistory Json[] @default([]) // Track all answer attempts
  hintsUsed     Int    @default(0) // Number of hints requested

  // Performance
  timeSpent    Int? // Time spent in seconds
  attempts     Int  @default(1) // Number of attempts for this activity
  mistakeCount Int  @default(0) // Number of wrong attempts before success

  // XP and rewards
  xpEarned     Int     @default(0) // XP earned from this activity
  perfectScore Boolean @default(false) // Completed on first try without hints

  // Timestamps
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@unique([userId, activityId])
  @@index([userId])
  @@index([activityId])
  @@index([isCompleted])
  @@index([completedAt])
  @@map("activity_progress")
}

// Removed LessonSession model

// Track daily user activity and streaks
model UserDailyActivity {
  id     String   @id @default(uuid())
  userId String
  date   DateTime @db.Date // Date of activity (without time)

  // Activity metrics
  unitsCompleted      Int @default(0)
  activitiesCompleted Int @default(0)
  timeSpent           Int @default(0) // Time in seconds
  xpEarned            Int @default(0)

  // Streak calculation
  isStreakDay Boolean @default(true) // Did user meet minimum criteria for streak

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@index([isStreakDay])
  @@map("user_daily_activity")
}

// Track mistakes and incorrect answers for learning insights
model UserMistake {
  id         String @id @default(uuid())
  userId     String
  activityId String
  unitId     String

  // Mistake details
  questionText  String  @db.Text
  userAnswer    Json // What they answered
  correctAnswer Json // What the correct answer was
  mistakeType   String? // e.g., "spelling", "grammar", "vocabulary", "pronunciation"

  // Learning value
  wasReviewed    Boolean   @default(false) // Has user seen this in review
  reviewCount    Int       @default(0) // How many times reviewed
  lastReviewedAt DateTime?
  isMastered     Boolean   @default(false) // User now gets this correct consistently

  createdAt DateTime @default(now())

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  unit     Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([activityId])
  @@index([unitId])
  @@index([wasReviewed])
  @@index([isMastered])
  @@index([createdAt])
  @@map("user_mistakes")
}
