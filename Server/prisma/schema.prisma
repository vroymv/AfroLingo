// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id    String @id @default(uuid())
  email String @unique
  name  String

  // Profile image
  profileImageUrl       String? // URL to user's profile image
  // Onboarding selections
  selectedLanguage      String? // e.g., "sw", "zu", "ln", "xh"
  selectedLevel         String? // e.g., "absolute-beginner", "beginner", "refresher"
  placementTestScore    Int?
  learningReasons       String[]  @default([]) // Array of reasons why they're learning
  timeCommitment        String? // e.g., "5min", "15min", "30min"
  onboardingCompleted   Boolean   @default(false)
  onboardingCompletedAt DateTime?
  currentOnboardingStep String? // Tracks the last onboarding step completed

  // Daily goal configuration & streaks
  dailyXpGoal       Int       @default(30) // Target XP per day
  dailyLessonGoal   Int? // Optional: target lessons per day
  timezone          String? // IANA timezone, e.g. "Africa/Nairobi"
  currentStreakDays Int       @default(0)
  longestStreakDays Int       @default(0)
  lastStreakDate    DateTime? @db.Date

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  progress         UserProgress[]
  activityProgress ActivityProgress[]
  dailyActivity    UserDailyActivity[]
  mistakes         UserMistake[]
  xpTransactions   XpTransaction[]

  @@map("users")
}

// Unit model - Represents a learning unit (e.g., "The Alphabet", "Numbers")
model Unit {
  id         String   @id @default(uuid())
  externalId String   @unique // e.g., "unit-1" from JSON
  title      String
  level      String // e.g., "absolute-beginner", "beginner"
  icon       String // Emoji icon
  color      String // Hex color code
  xpReward   Int // XP awarded for completing this unit
  order      Int      @default(0) // For ordering units
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  userProgress UserProgress[]
  activities   Activity[]
  mistakes     UserMistake[]

  @@index([externalId])
  @@index([order])
  @@map("units")
}

// Activity model - Represents an activity within a lesson
model Activity {
  id           String  @id @default(uuid())
  externalId   String  @unique // e.g., "activity-alphabet-1" from JSON
  unitId       String
  type         String // high-level category, e.g., "multiple-choice", "dictation"
  // Metadata-only: identifier for the client-side component to render this activity
  componentKey String  @default("generic-activity") // e.g., "learn/alphabet/AlphabetActivity" or "learn/mcq/MultipleChoice"
  // Reference to external content (JSON key, CMS ID, file path, etc.)
  contentRef   String? // e.g., "activity-alphabet-1" in JSON, or "s3://.../activity.json"
  order        Int     @default(0) // For ordering activities within a lesson
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  unit             Unit               @relation(fields: [unitId], references: [id], onDelete: Cascade)
  activityProgress ActivityProgress[]
  mistakes         UserMistake[]

  @@index([externalId])
  @@index([unitId])
  @@index([order])
  @@index([type])
  @@index([componentKey])
  @@map("activities")
}

// User progress for units
model UserProgress {
  id                  String    @id @default(uuid())
  userId              String
  unitId              String
  progress            Int       @default(0) // 0-100
  completedActivities Int       @default(0)
  startedAt           DateTime  @default(now())
  completedAt         DateTime?
  lastAccessedAt      DateTime  @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([userId, unitId])
  @@index([userId])
  @@index([unitId])
  @@map("user_progress")
}

// Removed LessonProgress model

// User progress for individual activities
model ActivityProgress {
  id         String @id @default(uuid())
  userId     String
  activityId String

  // Completion status
  isCompleted Boolean  @default(false)
  isCorrect   Boolean? // For activities with right/wrong answers
  isSkipped   Boolean  @default(false) // Did user skip this activity

  // Answer tracking
  userAnswer    Json? // Store user's final answer(s)
  answerHistory Json[] @default([]) // Track all answer attempts
  hintsUsed     Int    @default(0) // Number of hints requested

  // Performance
  timeSpent    Int? // Time spent in seconds
  attempts     Int  @default(1) // Number of attempts for this activity
  mistakeCount Int  @default(0) // Number of wrong attempts before success

  // XP and rewards
  xpEarned     Int     @default(0) // XP earned from this activity
  perfectScore Boolean @default(false) // Completed on first try without hints

  // Timestamps
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@unique([userId, activityId])
  @@index([userId])
  @@index([activityId])
  @@index([isCompleted])
  @@index([completedAt])
  @@map("activity_progress")
}

// Removed LessonSession model

// Track daily user activity and streaks
model UserDailyActivity {
  id     String   @id @default(uuid())
  userId String
  date   DateTime @db.Date // Date of activity (without time)

  // Activity metrics
  unitsCompleted      Int @default(0)
  activitiesCompleted Int @default(0)
  // App usage (best-effort; app may terminate without sending a close event)
  firstAppOpenedAt DateTime? // First time the app was opened on this date (server time)
  lastAppOpenedAt  DateTime? // Most recent app open on this date (server time)
  lastAppClosedAt  DateTime? // Most recent app close/background on this date (server time)
  appOpensCount     Int       @default(0)
  appClosesCount    Int       @default(0)
  xpEarned            Int @default(0)

  // Daily goal snapshot
  goalXp      Int?
  goalLessons Int?
  metGoal     Boolean @default(false)

  // Streak calculation
  isStreakDay Boolean @default(false) // Did user meet minimum criteria for streak

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@index([isStreakDay])
  @@map("user_daily_activity")
}

// Track mistakes and incorrect answers for learning insights
model UserMistake {
  id         String @id @default(uuid())
  userId     String
  activityId String
  unitId     String

  // Mistake details
  questionText  String  @db.Text
  userAnswer    Json // What they answered
  correctAnswer Json // What the correct answer was
  mistakeType   String? // e.g., "spelling", "grammar", "vocabulary", "pronunciation"

  // Learning value
  wasReviewed    Boolean   @default(false) // Has user seen this in review
  reviewCount    Int       @default(0) // How many times reviewed
  lastReviewedAt DateTime?
  isMastered     Boolean   @default(false) // User now gets this correct consistently

  createdAt DateTime @default(now())

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  unit     Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([activityId])
  @@index([unitId])
  @@index([wasReviewed])
  @@index([isMastered])
  @@index([createdAt])
  @@map("user_mistakes")
}

// XP Transaction model - Ledger for all XP changes
model XpTransaction {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  amount         Int // can be positive or negative
  sourceType     String   @map("source_type") // e.g. 'lesson_complete', 'quiz_attempt', 'streak_bonus'
  sourceId       String   @map("source_id") // ID of the originating entity (lessonId, attemptId, date, etc.)
  idempotencyKey String   @map("idempotency_key") // prevents duplicate awards on retries
  metadata       Json? // optional context: lang, difficulty, time spent, etc.
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("xp_transactions")
}
